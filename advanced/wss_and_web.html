<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebSocket + TLS + Web | 新 V2Ray 白话文指南</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="V2Fly 社区维护的新手向教程。">
    
    <link rel="preload" href="/assets/css/0.styles.3fa20a7b.css" as="style"><link rel="preload" href="/assets/js/app.a91cb4a1.js" as="script"><link rel="preload" href="/assets/js/2.83e89c77.js" as="script"><link rel="preload" href="/assets/js/36.f5558413.js" as="script"><link rel="prefetch" href="/assets/js/10.34249071.js"><link rel="prefetch" href="/assets/js/100.1b0a4ca6.js"><link rel="prefetch" href="/assets/js/101.e6f6e9b6.js"><link rel="prefetch" href="/assets/js/102.9dace5ad.js"><link rel="prefetch" href="/assets/js/11.b87c7650.js"><link rel="prefetch" href="/assets/js/12.3316b1ed.js"><link rel="prefetch" href="/assets/js/13.ce0d1183.js"><link rel="prefetch" href="/assets/js/14.75db315f.js"><link rel="prefetch" href="/assets/js/15.7319433d.js"><link rel="prefetch" href="/assets/js/16.e0c41430.js"><link rel="prefetch" href="/assets/js/17.704f9c52.js"><link rel="prefetch" href="/assets/js/18.ffd3e1f7.js"><link rel="prefetch" href="/assets/js/19.95fa6dc0.js"><link rel="prefetch" href="/assets/js/20.b972107c.js"><link rel="prefetch" href="/assets/js/21.b91e48b5.js"><link rel="prefetch" href="/assets/js/22.ac7cc091.js"><link rel="prefetch" href="/assets/js/23.b8ef576c.js"><link rel="prefetch" href="/assets/js/24.e2392c24.js"><link rel="prefetch" href="/assets/js/25.77c39609.js"><link rel="prefetch" href="/assets/js/26.5e1b66c4.js"><link rel="prefetch" href="/assets/js/27.f6e0a07c.js"><link rel="prefetch" href="/assets/js/28.788fc1b3.js"><link rel="prefetch" href="/assets/js/29.87e3cf98.js"><link rel="prefetch" href="/assets/js/3.3e348ebf.js"><link rel="prefetch" href="/assets/js/30.7d314a2a.js"><link rel="prefetch" href="/assets/js/31.92dc2759.js"><link rel="prefetch" href="/assets/js/32.30ae26dc.js"><link rel="prefetch" href="/assets/js/33.f2866956.js"><link rel="prefetch" href="/assets/js/34.52ee4a5d.js"><link rel="prefetch" href="/assets/js/35.4fcfbef2.js"><link rel="prefetch" href="/assets/js/37.49dd6b65.js"><link rel="prefetch" href="/assets/js/38.9a2bb3d3.js"><link rel="prefetch" href="/assets/js/39.399ea539.js"><link rel="prefetch" href="/assets/js/4.bbc98ae8.js"><link rel="prefetch" href="/assets/js/40.82b3c875.js"><link rel="prefetch" href="/assets/js/41.4a2bcd0a.js"><link rel="prefetch" href="/assets/js/42.e872d864.js"><link rel="prefetch" href="/assets/js/43.59863d01.js"><link rel="prefetch" href="/assets/js/44.29880102.js"><link rel="prefetch" href="/assets/js/45.093081f6.js"><link rel="prefetch" href="/assets/js/46.8311a9f7.js"><link rel="prefetch" href="/assets/js/47.1bc59cdb.js"><link rel="prefetch" href="/assets/js/48.854c34c4.js"><link rel="prefetch" href="/assets/js/49.3d24b885.js"><link rel="prefetch" href="/assets/js/5.8bf7c584.js"><link rel="prefetch" href="/assets/js/50.1ec30786.js"><link rel="prefetch" href="/assets/js/51.e7865f4e.js"><link rel="prefetch" href="/assets/js/52.0760dc92.js"><link rel="prefetch" href="/assets/js/53.8b2ba6ac.js"><link rel="prefetch" href="/assets/js/54.e5b275fd.js"><link rel="prefetch" href="/assets/js/55.c830c653.js"><link rel="prefetch" href="/assets/js/56.cb28a164.js"><link rel="prefetch" href="/assets/js/57.5071542b.js"><link rel="prefetch" href="/assets/js/58.818b558d.js"><link rel="prefetch" href="/assets/js/59.ac7f2e0f.js"><link rel="prefetch" href="/assets/js/6.d0222fb1.js"><link rel="prefetch" href="/assets/js/60.fc316207.js"><link rel="prefetch" href="/assets/js/61.d382608c.js"><link rel="prefetch" href="/assets/js/62.7412544d.js"><link rel="prefetch" href="/assets/js/63.9a4b2d27.js"><link rel="prefetch" href="/assets/js/64.b620991e.js"><link rel="prefetch" href="/assets/js/65.a3abe2d4.js"><link rel="prefetch" href="/assets/js/66.deca69a0.js"><link rel="prefetch" href="/assets/js/67.bc164917.js"><link rel="prefetch" href="/assets/js/68.42e9b243.js"><link rel="prefetch" href="/assets/js/69.9cdc0d80.js"><link rel="prefetch" href="/assets/js/7.678af2e3.js"><link rel="prefetch" href="/assets/js/70.a9155d85.js"><link rel="prefetch" href="/assets/js/71.9eb06d45.js"><link rel="prefetch" href="/assets/js/72.2e4f01e2.js"><link rel="prefetch" href="/assets/js/73.a5a3eea5.js"><link rel="prefetch" href="/assets/js/74.c6de7913.js"><link rel="prefetch" href="/assets/js/75.b85002e0.js"><link rel="prefetch" href="/assets/js/76.dc1c599d.js"><link rel="prefetch" href="/assets/js/77.e67408af.js"><link rel="prefetch" href="/assets/js/78.a849cf7e.js"><link rel="prefetch" href="/assets/js/79.d22ff3c9.js"><link rel="prefetch" href="/assets/js/8.82ca2c7a.js"><link rel="prefetch" href="/assets/js/80.af4ca83b.js"><link rel="prefetch" href="/assets/js/81.96f4dc38.js"><link rel="prefetch" href="/assets/js/82.d317c4ce.js"><link rel="prefetch" href="/assets/js/83.936246b1.js"><link rel="prefetch" href="/assets/js/84.fcc00c24.js"><link rel="prefetch" href="/assets/js/85.df0a9323.js"><link rel="prefetch" href="/assets/js/86.e80e3112.js"><link rel="prefetch" href="/assets/js/87.57df6260.js"><link rel="prefetch" href="/assets/js/88.4dbf4bd3.js"><link rel="prefetch" href="/assets/js/89.6ae14544.js"><link rel="prefetch" href="/assets/js/9.e3c65114.js"><link rel="prefetch" href="/assets/js/90.3a4bfff9.js"><link rel="prefetch" href="/assets/js/91.8a45d470.js"><link rel="prefetch" href="/assets/js/92.468caa52.js"><link rel="prefetch" href="/assets/js/93.8bd44d43.js"><link rel="prefetch" href="/assets/js/94.427b05f3.js"><link rel="prefetch" href="/assets/js/95.c8bb2a4c.js"><link rel="prefetch" href="/assets/js/96.26322699.js"><link rel="prefetch" href="/assets/js/97.0146d3f5.js"><link rel="prefetch" href="/assets/js/98.c9592100.js"><link rel="prefetch" href="/assets/js/99.a341125c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3fa20a7b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">新 V2Ray 白话文指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://v2fly.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官方手册
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advanced/wss_and_web.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  zh-CN
</a></li><li class="dropdown-item"><!----> <a href="/en_US/advanced/wss_and_web.html" class="nav-link">
  en-US
</a></li></ul></div></div> <a href="https://github.com/v2fly/v2ray-step-by-step" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://v2fly.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官方手册
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advanced/wss_and_web.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  zh-CN
</a></li><li class="dropdown-item"><!----> <a href="/en_US/advanced/wss_and_web.html" class="nav-link">
  en-US
</a></li></ul></div></div> <a href="https://github.com/v2fly/v2ray-step-by-step" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/" aria-current="page" class="sidebar-link">V2Ray 配置指南</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prep/prep" class="sidebar-heading clickable"><span>开篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/basics/basics" class="sidebar-heading clickable"><span>基本篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/advanced/advanced" class="sidebar-heading clickable open"><span>高级篇</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/advanced/mux.html" class="sidebar-link">Mux</a></li><li><a href="/advanced/mkcp.html" class="sidebar-link">mKCP</a></li><li><a href="/advanced/dynamicport.html" class="sidebar-link">动态端口</a></li><li><a href="/advanced/outboundproxy.html" class="sidebar-link">代理转发</a></li><li><a href="/advanced/httpfake.html" class="sidebar-link">HTTP 伪装</a></li><li><a href="/advanced/tls.html" class="sidebar-link">TLS</a></li><li><a href="/advanced/tcp_tls_web.html" class="sidebar-link">TCP + TLS + Web</a></li><li><a href="/advanced/tcp_tls_shunt_proxy.html" class="sidebar-link">TCP + TLS 分流器</a></li><li><a href="/advanced/websocket.html" class="sidebar-link">WebSocket</a></li><li><a href="/advanced/wss_and_web.html" aria-current="page" class="active sidebar-link">WebSocket + TLS + Web</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advanced/wss_and_web.html#配置" class="sidebar-link">配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advanced/wss_and_web.html#服务器配置" class="sidebar-link">服务器配置</a></li><li class="sidebar-sub-header"><a href="/advanced/wss_and_web.html#客户端配置" class="sidebar-link">客户端配置</a></li><li class="sidebar-sub-header"><a href="/advanced/wss_and_web.html#注意事项" class="sidebar-link">注意事项</a></li><li class="sidebar-sub-header"><a href="/advanced/wss_and_web.html#其他的话" class="sidebar-link">其他的话</a></li></ul></li></ul></li><li><a href="/advanced/h2.html" class="sidebar-link">HTTP/2</a></li><li><a href="/advanced/h2_tls_web.html" class="sidebar-link">HTTP/2+TLS+WEB</a></li><li><a href="/advanced/tls_routing_with_nginx.html" class="sidebar-link">基于 Nginx 的简单 TLS 分流</a></li><li><a href="/advanced/cdn.html" class="sidebar-link">CDN</a></li><li><a href="/advanced/traffic.html" class="sidebar-link">流量统计</a></li><li><a href="/advanced/tor.html" class="sidebar-link">Tor</a></li><li><a href="/advanced/not_recommend.html" class="sidebar-link">不推荐的配置</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/app/app" class="sidebar-heading clickable"><span>应用篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/routing/routing" class="sidebar-heading clickable"><span>路由</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="websocket-tls-web"><a href="#websocket-tls-web" class="header-anchor">#</a> WebSocket + TLS + Web</h1> <p>前文分别提到过 TLS 和 WebSocket 的配置方法，而本文搭配 Web 服务并同时实现 TLS 和 WebSocket。关于 Web 的软件本文给出了 Nginx，Caddy 和 Apache 三个例子，三选一即可，也可以选用其它的软件。</p> <p>很多新手一接触 V2Ray 就想搞 WebSocket + TLS + Web 或 WebSocket + TLS + Web + CDN，我就想问 ssh 和 vim/nano 用利索了没，步子这么大不怕扯到蛋吗？使用 Nginx/Caddy/Apache 是因为 VPS 已经有 Nginx/Caddy/Apache 可以将 V2Ray 稍作隐藏，使用 WebSocket 是因为搭配 Nginx/Caddy/Apache 只能用 WebSocket，使用 TLS 是因为可以流量加密，看起来更像 HTTPS。 也许 WebSocket + TLS + Web 的配置组合相对较好，但不意味着这样的配置适合任何人。因为本节涉及 Nginx/Caddy/Apache，只给出了配置示例而不讲具体使用方法，也就是说你在阅读本节内容前得会使用这三个软件的其中之一，如果你还不会，请自行 Google。</p> <p>注意: V2Ray 的 Websocket + TLS 配置组合并不依赖 Nginx/Caddy/Apache，只是能与其搭配使用而已，没有它们也可以正常使用。</p> <h2 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h2> <h3 id="服务器配置"><a href="#服务器配置" class="header-anchor">#</a> 服务器配置</h3> <p>这次 TLS 的配置将写入 Nginx/Caddy/Apache 配置中，由这些软件来监听 443 端口（443 比较常用，并非 443 不可），然后将流量转发到 V2Ray 的 WebSocket 所监听的内网端口（本例是 10000），V2Ray 服务器端不需要配置 TLS。</p> <h4 id="服务器-v2ray-配置"><a href="#服务器-v2ray-配置" class="header-anchor">#</a> 服务器 V2Ray 配置</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
      <span class="token property">&quot;listen&quot;</span><span class="token operator">:</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token comment">//只监听 127.0.0.1，避免除本机外的机器探测到开放了 10000 端口</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vmess&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;clients&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;b831381d-6324-4d53-ad4f-8cda48b30811&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;alterId&quot;</span><span class="token operator">:</span> <span class="token number">64</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;wsSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/ray&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;freedom&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="证书配置"><a href="#证书配置" class="header-anchor">#</a> 证书配置</h4> <p>Nginx 配置和 Apache 配置中使用的是域名和证书使用 TLS 小节的举例，请替换成自己的。因为 Caddy 会自动申请证书并自动更新，所以使用 Caddy 不用指定证书、密钥。</p> <p>注意: 如果你有的 VPS 上有架设网页，请使用 webroot 模式生成证书而不是 TLS 小节中提到的 standalone 模式。以下仅就两种模式的些微不同举例，相同部分参照 TLS 小节。本例中使用的是 ECC 证书，若要生成 RSA 证书，删去 <code>--keylength ec-256</code> 或 <code>--ecc</code> 参数即可。详细请参考 <a href="https://github.com/acmesh-official/acme.sh/wiki" target="_blank" rel="noopener noreferrer">acmesh-official/acme.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>证书生成</p> <div class="language-plain extra-class"><pre class="language-text"><code>$ ~/.acme.sh/acme.sh --issue -d mydomain.me --webroot --keylength ec-256
</code></pre></div><p>安装证书和密钥</p> <div class="language-plain extra-class"><pre class="language-text"><code>acme.sh --install-cert -d mydomain.com --ecc \
        --key-file       /etc/v2ray/v2ray.key \
        --fullchain-file /etc/v2ray/v2ray.crt \
        --reloadcmd     &quot;service nginx force-reload&quot;
</code></pre></div><h4 id="nginx-配置"><a href="#nginx-配置" class="header-anchor">#</a> Nginx 配置</h4> <div class="language-plain extra-class"><pre class="language-text"><code>server {
  listen 443 ssl;
  listen [::]:443 ssl;
  
  ssl_certificate       /etc/v2ray/v2ray.crt;
  ssl_certificate_key   /etc/v2ray/v2ray.key;
  ssl_session_timeout 1d;
  ssl_session_cache shared:MozSSL:10m;
  ssl_session_tickets off;
  
  ssl_protocols         TLSv1.2 TLSv1.3;
  ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
  ssl_prefer_server_ciphers off;
  
  server_name           mydomain.me;
  location /ray { # 与 V2Ray 配置中的 path 保持一致
    if ($http_upgrade != &quot;websocket&quot;) { # WebSocket协商失败时返回404
        return 404;
    }
    proxy_redirect off;
    proxy_pass http://127.0.0.1:10000; # 假设WebSocket监听在环回地址的10000端口上
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection &quot;upgrade&quot;;
    proxy_set_header Host $host;
    # Show real IP in v2ray access.log
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
</code></pre></div><h4 id="caddy-配置"><a href="#caddy-配置" class="header-anchor">#</a> Caddy 配置</h4> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在配置之前请先检查当前安装的 Caddy 的版本，两者的配置格式并不完全兼容。推荐使用 Caddy v2。
注意 Caddy 在 v2.2.0-rc.1 版本以后修复了无法转发 WebSocket 的 bug，请使用以后的版本进行安装。</p></div> <div class="language-plain extra-class"><pre class="language-text"><code># Caddy v2 (recommended)
mydomain.me {
    log {
        output file /etc/caddy/caddy.log
    }
    tls {
        protocols tls1.2 tls1.3
        ciphers TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256
        curves x25519
    }
    @v2ray_websocket {
        path /ray
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @v2ray_websocket localhost:10000
}
</code></pre></div><div class="language-plain extra-class"><pre class="language-text"><code># Caddy v1 (deprecated)
mydomain.me
{
  log ./caddy.log
  protocols tls1.2 tls1.3
  ciphers ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-RSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-RSA-AES256-GCM-SHA384 ECDHE-ECDSA-WITH-CHACHA20-POLY1305 ECDHE-RSA-WITH-CHACHA20-POLY1305
  proxy /ray localhost:10000 {
    websocket
    header_upstream -Origin
  }
}
</code></pre></div><h4 id="apache-配置"><a href="#apache-配置" class="header-anchor">#</a> Apache 配置</h4> <div class="language-plain extra-class"><pre class="language-text"><code>&lt;VirtualHost *:443&gt;
  SSLEngine on
  
  SSLCertificateFile /etc/v2ray/v2ray.crt
  SSLCertificateKeyFile /etc/v2ray/v2ray.key
  
  SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
  SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
  SSLHonorCipherOrder     off
  SSLSessionTickets       off
  
  &lt;Location &quot;/ray/&quot;&gt;
    ProxyPass ws://127.0.0.1:10000/ray/ upgrade=WebSocket
    ProxyAddHeaders Off
    ProxyPreserveHost On
    RequestHeader append X-Forwarded-For %{REMOTE_ADDR}s
  &lt;/Location&gt;
&lt;/VirtualHost&gt;
</code></pre></div><h3 id="客户端配置"><a href="#客户端配置" class="header-anchor">#</a> 客户端配置</h3> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">1080</span><span class="token punctuation">,</span>
      <span class="token property">&quot;listen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;socks&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sniffing&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;destOverride&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tls&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;auth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;noauth&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;udp&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vmess&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;vnext&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mydomain.me&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">443</span><span class="token punctuation">,</span>
            <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;b831381d-6324-4d53-ad4f-8cda48b30811&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;alterId&quot;</span><span class="token operator">:</span> <span class="token number">64</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;security&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tls&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;wsSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/ray&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <ul><li>V2Ray 自 4.18.1 后支持 TLS1.3，如果开启并强制 TLS1.3 请注意 v2ray 客户端版本.</li> <li>较低版本的 nginx 的 location 需要写为 /ray/ 才能正常工作</li> <li>如果在设置完成之后不能成功使用，可能是由于 SElinux 机制(如果你是 CentOS 7 的用户请特别留意 SElinux 这一机制)阻止了 Nginx 转发向内网的数据。如果是这样的话，在 V2Ray 的日志里不会有访问信息，在 Nginx 的日志里会出现大量的 &quot;Permission Denied&quot; 字段，要解决这一问题需要在终端下键入以下命令：<div class="language-plain extra-class"><pre class="language-text"><code>setsebool -P httpd_can_network_connect 1
</code></pre></div></li> <li>请保持服务器和客户端的 wsSettings 严格一致，对于 V2Ray，<code>/ray</code> 和 <code>/ray/</code> 是不一样的</li> <li>较低版本的系统/浏览器可能无法完成握手. 如 Chrome 49/XP SP3, Safari 8/iOS 8.4, Safari 8/OS X 10.10 及更低的版本. 如果你的设备比较旧, 则可以通过在配置中添加较旧的 TLS 协议以完成握手.</li></ul> <h3 id="其他的话"><a href="#其他的话" class="header-anchor">#</a> 其他的话</h3> <ol><li>开启了 TLS 之后 path 参数是被加密的，GFW 看不到；</li> <li>主动探测一个 path 产生 Bad request 不能证明是 V2Ray；</li> <li>不安全的因素在于人，自己的问题就不要甩锅，哪怕我把示例中的 path 改成一个 UUID，依然有不少人原封不动地 COPY；</li> <li>使用 Header 分流并不比 path 安全， 不要迷信。</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/v2fly/v2ray-step-by-step/edit/transifex/zh_CN/advanced/wss_and_web.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">6/23/2020, 12:39:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/websocket.html" class="prev">
        WebSocket
      </a></span> <span class="next"><a href="/advanced/h2.html">
        HTTP/2
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a91cb4a1.js" defer></script><script src="/assets/js/2.83e89c77.js" defer></script><script src="/assets/js/36.f5558413.js" defer></script>
  </body>
</html>
